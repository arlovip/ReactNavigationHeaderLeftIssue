```mermaid
flowchart TD
    %% 应用启动与新消息检查
    A[App 启动] --> B[查询 Realm 数据库<br/>是否存在智能体?]
    B -->|否| Z[流程结束]
    B -->|是| C[调用服务端接口<br/>传入所有 agentId 列表及最大 messageId]
    C --> D{是否有新消息?}
    D -->|否| Z
    D -->|是| E[接收新消息的 agentId<br/>及对应 messageId 列表]
    E --> F[查询历史消息接口<br/>传入 agentId 列表]
    F --> G[更新 Realm 数据库<br/>写入新历史消息]
    G --> H[显示智能体列表界面]
    
    %% 收到通知分支
    N1[收到新消息通知] --> N2{应用在前台?}
    N2 -->|否| A
    N2 -->|是| N3[调用历史聊天接口<br/>拉取最新 N 条消息]
    N3 --> P1[更新 Realm 数据库<br/>追加新消息]
    P1 --> Q1[刷新聊天界面列表]
    
    %% 用户交互流程
    H --> I[用户选择某个智能体]
    I --> J[进入聊天详情页面<br/>查询本地 Realm 数据]
    J --> K{本地是否有存储消息?}
    K -->|否| L[直接调用历史聊天接口<br/>拉取最新 N 条消息]
    K -->|是| M[加载本地存储的消息]
    
    L --> N{是否有最新聊天消息?}
    M --> N
    N -->|否| O[显示本地消息，无更新]
    N -->|是| P[更新 Realm 数据库<br/>追加新消息]
    P --> Q[刷新聊天界面列表]
    
    Q --> R[用户退出聊天页面]
    R --> S[调用历史聊天接口<br/>拉取更多历史消息]
    S --> T[更新 Realm 数据库<br/>追加历史消息]
    T --> Z
